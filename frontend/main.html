<!DOCTYPE html>
<html>
    <head>
        <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.12.min.js"></script>
        <script src="https://unpkg.com/aws-amplify@3.3.27/dist/aws-amplify.min.js"></script>
        <title>Upload to S3</title>
    </head>
    <body>
        <button id="uploadButton">Upload File</button>
        <input type="file" id="fileUpload" style="display: none" />
        <script type="text/javascript">
            // Import AWS Amplify
            var Amplify = window.AWSAmplify;

            // Configure Amplify
            Amplify.configure({
                Auth: {
                    region: 'us-east-1',
                    userPoolId: 'us-east-1_noGkk04sC', // your user pool ID
                    userPoolWebClientId: '2bo2g45f23039mjhqjt0p18d79', // your app client ID
                }
            });

            var uploadButton = document.getElementById('uploadButton');
            var fileUpload = document.getElementById('fileUpload');

            uploadButton.addEventListener('click', function() {
                fileUpload.click();
            });

            fileUpload.addEventListener('change', function() {
                var file = fileUpload.files[0];
                if (file) {
                    handleFileUpload(file);
                }
            });

            function handleFileUpload(file) {
                var reader = new FileReader();
                reader.onload = function() {
                    var fileContent = reader.result;
                    uploadToS3(file.name, fileContent);
                };
                reader.readAsText(file);
            }

            async function uploadToS3(filename, fileContent) {
                try {
                    const currentSession = await Amplify.Auth.currentSession();
                    const idToken = currentSession.getIdToken().getJwtToken();

                    var AWS = window.AWS;
                    AWS.config.region = 'us-east-1';

                    AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                        IdentityPoolId: 'us-east-1:caa20059-c2bd-416c-94c1-43988c2e10e3', // replace with your Identity Pool ID
                        Logins: {
                            'cognito-idp.us-east-1.amazonaws.com/us-east-1_noGkk04sC': idToken
                        }
                    });

                    AWS.config.credentials.get(function() {
                        var s3 = new AWS.S3({
                            apiVersion: '2006-03-01',
                            params: {Bucket: 'assigment2-group6-bucket'}
                        });

                        s3.upload({Key: filename, Body: fileContent}, function(err, data) {
                            if (err) {
                                console.log(err, 'There was an error uploading your file');
                            } else {
                                console.log('Successfully uploaded file.');
                            }
                        });
                    });
                }
                catch(err) {
                    console.log(err);
                }
            }
        </script>
    </body>
</html>
